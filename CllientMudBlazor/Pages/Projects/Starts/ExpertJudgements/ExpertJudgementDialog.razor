
@* ExpertJudgementDialog.razor *@  
@inherits ComponentBase

<TemplateDialog TValue="ExpertJudgementDto"
                Model="@Model"
                OnSubmit="Submit"
                OnCancel="Cancel">

    <Content Context="ctx">
        <MudGrid>
            <MudItem xs="12">
                <AutoCompleteIconButton @bind-Value="@ctx.Model.Expert"
                                        TValue="StakeHolderDto"
                                        Label="Select Expert"
                                        ValidateAsync="ctx.ValidateAsync"
                                        For="()=>ctx.Model.Expert"
                                        Clearable="true"
                                        SearchFunc="SearchStakeHolder"
                                        ToStringFunc="@(e=> e==null?null : $"{e.Name} ")"
                                        Icon="@Icons.Material.Filled.Add"
                                        ButtonClick="AddStakeHolder"
                                        ToolTip="Add new Expert"
                                        Change="ChangeStakeHolder">

                </AutoCompleteIconButton>


            </MudItem>
            <MudItem xs="12">
                <TextField @bind-Value="@ctx.Model.Name"
                           Label="Expert concept"
                           Lines="3"
                           ValidateAsync="@ctx.ValidateAsync"
                           For="@(() => ctx.Model.Name)">
                </TextField>

            </MudItem>
        </MudGrid>
    </Content>

</TemplateDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public ExpertJudgementDto Model { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // Solo carga si es edición
        if (Model.Id != Guid.Empty)
        {
            var result = await HttpService.PostAsync<GetExpertJudgementById, GeneralDto<EditExpertJudgement>>(
                new GetExpertJudgementById { Id = Model.Id });

            if (result.Succeeded && result.Data != null)
            {
                Model = result.Data;
            }
        }
        await GetStakeholders();
    }

    private async Task Submit()
    {
        var result = await HttpService.PostAsync<ExpertJudgementDto, GeneralDto>(Model);
        if (result.Succeeded)
        {
            MudDialog.Close(DialogResult.Ok(true));
        }
    }

    private void Cancel() => MudDialog.Cancel();
    private Task<IEnumerable<StakeHolderDto>> SearchStakeHolder(string value, CancellationToken token)
    {
        Func<StakeHolderDto, bool> Criteria = x =>
        x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase) ||
        x.Area.Contains(value, StringComparison.InvariantCultureIgnoreCase) ||
        x.Email.Contains(value, StringComparison.InvariantCultureIgnoreCase);
        IEnumerable<StakeHolderDto> FilteredItems = string.IsNullOrEmpty(value) ? stakeHolders.AsEnumerable() :
            stakeHolders.Where(Criteria);
        return Task.FromResult(FilteredItems);
    }
    void ChangeStakeHolder()
    {
        if (Model.Expert != null)
        {



        }

    }
    public async Task AddStakeHolder()
    {
        CreateStakeHolder dto = new();
        var parameters = new DialogParameters<StakeHolderDialog>
        {
              { x => x.Model, dto},
        };

        var options = new DialogOptions() { MaxWidth = MaxWidth.Small };

        var dialog = await DialogService.ShowAsync<StakeHolderDialog>("Add StakeHolder", parameters, options);
        var result = await dialog.Result;
        if (result != null)
        {
            await GetStakeholders();

        }
    }
    List<StakeHolderDto> stakeHolders = new();
    async Task GetStakeholders()
    {
        var result = await HttpService.PostAsync<GetAllStakeHolders, GeneralDto<List<StakeHolderDto>>>(new GetAllStakeHolders());
        if (result.Succeeded)
        {
            stakeHolders = result.Data;
            StateHasChanged();
        }
    }
}
